#!/bin/bash
# Pre-commit hook for Ship Commander 3
# Runs formatting, linting, and tests before allowing commits
# Reference: .spec/research-findings/GO_CODING_STANDARDS.md

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}ðŸ” Ship Commander 3 - Pre-commit Checks${NC}"
echo ""

# Function to print status
print_status() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

print_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

print_error() {
    echo -e "${RED}âŒ $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

# Get changed Go files
CHANGED_GO_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$' || true)

# Skip checks if no Go files changed
if [ -z "$CHANGED_GO_FILES" ]; then
    print_status "No Go files changed, skipping pre-commit checks"
    exit 0
fi

print_status "Running pre-commit checks on modified files:"
echo "$CHANGED_GO_FILES"
echo ""

# 1. Check formatting with gofmt and goimports
print_status "Step 1/5: Checking code formatting..."
if ! command -v goimports &> /dev/null; then
    print_warning "goimports not found, trying gofmt only..."
    UNFORMATTED=$(gofmt -l $CHANGED_GO_FILES || true)
else
    UNFORMATTED=$(goimports -l $CHANGED_GO_FILES 2>/dev/null || true)
fi

if [ -n "$UNFORMATTED" ]; then
    print_error "Code is not properly formatted."
    echo "Files with formatting issues:"
    echo "$UNFORMATTED"
    echo ""
    echo "Run 'make fmt' to fix formatting issues automatically:"
    echo "  make fmt"
    echo ""
    exit 1
fi
print_success "Code is properly formatted"

# 2. Run go vet
print_status "Step 2/5: Running go vet..."
if ! go vet ./... 2>&1 | grep -v "no Go files"; then
    print_error "go vet found issues"
    echo "Run 'make vet' to see details:"
    echo "  make vet"
    echo ""
    exit 1
fi
print_success "go vet passed"

# 3. Run golangci-lint (if available)
if command -v golangci-lint &> /dev/null; then
    print_status "Step 3/5: Running golangci-lint..."
    if ! golangci-lint run --new-from-rev=HEAD~1 --timeout=5m; then
        print_error "golangci-lint found issues"
        echo "Run 'make lint' to see all issues:"
        echo "  make lint"
        echo ""
        echo "Or run 'make lint-fast' for a quick check:"
        echo "  make lint-fast"
        echo ""
        exit 1
    fi
    print_success "golangci-lint passed"
else
    print_warning "golangci-lint not found, skipping"
    echo "Install with: go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest"
fi

# 4. Check for TODO/FIXME comments (warning only)
print_status "Step 4/5: Checking for TODO/FIXME comments..."
TODOS=$(git diff --cached $CHANGED_GO_FILES | grep -E '^\+.*TODO|FIXME|HACK|XXX' || true)
if [ -n "$TODOS" ]; then
    print_warning "Found TODO/FIXME comments in code:"
    echo "$TODOS"
    echo ""
fi

# 5. Run tests (only for changed packages)
print_status "Step 5/5: Running tests for changed packages..."
TEST_FAILED=0
for FILE in $CHANGED_GO_FILES; do
    DIR=$(dirname "$FILE")
    # Only test if this is a testable package (not cmd/ or test/)
    if [[ "$DIR" != ./cmd/* ]] && [[ "$DIR" != ./test/* ]] && [[ "$DIR" != *"testdata"* ]]; then
        print_status "Testing $DIR..."
        if ! go test -short "$DIR" > /dev/null 2>&1; then
            print_error "Tests failed for $DIR"
            TEST_FAILED=1
        fi
    fi
done

if [ $TEST_FAILED -eq 1 ]; then
    print_error "Some tests failed"
    echo "Run 'make test' to run all tests:"
    echo "  make test"
    echo ""
    exit 1
fi
print_success "All tests passed"

echo ""
print_success "All pre-commit checks passed! ðŸš€"
echo ""
