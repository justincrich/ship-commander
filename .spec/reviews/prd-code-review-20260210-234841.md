# PRD Code Review Report
## Ship Commander 3 - Phases 1-2

**Date**: 2026-02-10 23:48:41 UTC
**PRD**: `.spec/prd.md`
**Codebase**: `/Users/justinrich/Projects/ship-commander-3` (Go project)
**Review Type**: Adversarial (assume nothing correct)
**Test Coverage**: 77.3% overall

---

## Executive Summary

**Completion**: ~65% of Phase 1-2 requirements verified
**Recommendation**: **REQUEST CHANGES** - Strong foundation but critical observability gaps block phase completion

### Key Findings

‚úÖ **GO**: Core architecture is solid
- Commission parser with use case extraction
- Ready Room planning loop with session management
- Commander orchestrator with wave execution
- State machine and protocol event systems
- Demo token validation logic
- Telemetry package initialization (OTLP)

‚ùå **NO-GO**: Critical gaps in observability integration
- **Root spans NOT created** on command execution (UC-OBS-02)
- **NO run_id/trace_id correlation** in logs (UC-OBS-06)
- **NO deterministic tracing** for state transitions/tools/Git/tests (UC-OBS-03)
- **NO structured logging** integration with run_id/trace_id
- **NO sc3 bugreport command** (UC-OBS-10)
- **NO --debug flag** for console exporter (UC-OBS-08)

üîç **VERIFIABLE NOW**: What you can test immediately
- Run tests: `go test ./...` (77.3% coverage)
- Parse PRD: `./sc3 plan .spec/prd.md`
- Test state machine transitions
- Validate demo token schema
- Verify gate executor logic

üìã **MISSING**: Unverifiable without implementation
- End-to-end telemetry flow (run_id ‚Üí trace_id ‚Üí spans)
- Observability integration in main command
- Structured log correlation
- Debug bundle generation

---

## Technical Requirements Status

### PHASE 1: FOUNDATION + OBSERVABILITY SETUP

#### UC-COMM-01 (Create commission from PRD): ‚úÖ GO
**Evidence**: `internal/commission/parser.go:19-57`
**Gap**: None
**Verifiable Now**: YES
**Details**:
- ‚úÖ ParseFile reads markdown PRD files
- ‚úÖ ParseMarkdown extracts use cases, acceptance criteria, functional groups, scope boundaries
- ‚úÖ Commission struct persists all required fields
- ‚úÖ Test coverage: 77.6% in commission package
- ‚úÖ Uses goldmark parser with GFM extensions

#### UC-COMM-02 (Spawn Ready Room sessions): ‚úÖ GO
**Evidence**: `internal/readyroom/readyroom.go:101-110` (Session interface), `internal/readyroom/readyroom.go:289-306` (spawnSessions)
**Gap**: None
**Verifiable Now**: YES (interface defined, implementation via session factory)
**Details**:
- ‚úÖ SessionFactory interface for session spawning
- ‚úÖ Session interface with ID(), Execute(), Close()
- ‚úÖ SessionInput provides iteration, commission, inbox
- ‚úÖ ReadyRoom spawns captain, commander, designOfficer sessions
- ‚úÖ Test coverage: 85.2% in readyroom package

#### UC-COMM-03 (Captain functional analysis): ‚ö†Ô∏è PARTIAL
**Evidence**: `internal/readyroom/readyroom.go:22-31` (AgentRole enum), `internal/readyroom/readyroom.go:80-92` (SessionInput structure)
**Gap**: Session interface defined but concrete implementations MISSING (harness drivers incomplete - see UC-HARN-01, UC-HARN-02)
**Severity**: HIGH
**Verifiable Now**: NO (no actual agent sessions can run)
**Details**:
- ‚úÖ Role constants defined (RoleCaptain, RoleCommander, RoleDesignOfficer)
- ‚úÖ Session contract defined
- ‚ùå Actual Captain agent session implementation MISSING (harness not integrated)
- ‚ùå Cannot test functional analysis without real agent

#### UC-COMM-04 (Design Officer analysis): ‚ö†Ô∏è PARTIAL
**Evidence**: Same as UC-COMM-03
**Gap**: Design Officer session implementation MISSING
**Severity**: HIGH
**Verifiable Now**: NO

#### UC-COMM-05 (Commander mission decomposition): ‚ö†Ô∏è PARTIAL
**Evidence**: Same as UC-COMM-03
**Gap**: Commander planning session implementation MISSING
**Severity**: HIGH
**Verifiable Now**: NO

#### UC-COMM-06 (Inter-session message routing): ‚úÖ GO
**Evidence**: `internal/readyroom/readyroom.go:47-57` (ReadyRoomMessage), `internal/readyroom/readyroom.go:356-393` (routeMessages)
**Gap**: None
**Verifiable Now**: YES
**Details**:
- ‚úÖ Structured ReadyRoomMessage with From, To, Type, Domain, Content, Timestamp
- ‚úÖ routeMessages handles broadcast and targeted routing
- ‚úÖ Messages routed to mailboxes and persisted to message log
- ‚úÖ Invalid recipients return error

#### UC-COMM-07 (Consensus validation): ‚úÖ GO
**Evidence**: `internal/readyroom/readyroom.go:59-71` (MissionSignoffs), `internal/readyroom/readyroom.go:242-262` (ValidateConsensus)
**Gap**: None
**Verifiable Now**: YES
**Details**:
- ‚úÖ Three-way signoff tracking (Captain, Commander, DesignOfficer)
- ‚úÖ ValidateConsensus checks all missions fully signed
- ‚úÖ BuildUseCaseCoverage computes covered/partial/uncovered
- ‚úÖ Consensus requires all use cases covered

#### UC-COMM-08 (Agent ‚Üí Admiral question): ‚úÖ GO
**Evidence**: `internal/readyroom/readyroom.go:395-431` (handleQuestions), `internal/admiral/question_gate.go`
**Gap**: None
**Verifiable Now**: YES (logic complete, TUI integration pending)
**Details**:
- ‚úÖ Questions surfaced via QuestionGate with timeout
- ‚úÖ Answers routed back to asking agent
- ‚úÖ Broadcast support for sharing answers with all sessions
- ‚úÖ QuestionRecord persisted to planning log
- ‚ùå TUI modal integration missing (Phase 3)

#### UC-COMM-09 (Admiral approval gate): ‚úÖ GO
**Evidence**: `internal/admiral/approval_gate.go`, `internal/commander/commander.go:470-498` (resolveAdmiralDecision)
**Gap**: None
**Verifiable Now**: YES (logic complete, TUI integration pending)
**Details**:
- ‚úÖ ApprovalGate interface with AwaitDecision
- ‚úÖ Supports approve/feedback/shelve decisions
- ‚úÖ Commander handles feedback by injecting into Ready Room
- ‚úÖ Shelving persists plan for later resume
- ‚ùå TUI plan review overlay missing (Phase 3)

#### UC-COMM-10 (Plan persistence): ‚úÖ GO
**Evidence**: `internal/commission/plan_store.go`
**Gap**: None
**Verifiable Now**: YES
**Details**:
- ‚úÖ PlanStore interface for manifest persistence
- ‚úÖ Supports save, shelve, resume operations
- ‚úÖ Integrates with Beads for storage

#### UC-OBS-01 (Telemetry Init): ‚úÖ GO
**Evidence**: `internal/telemetry/telemetry.go:42-80` (Init function)
**Gap**: None
**Verifiable Now**: YES
**Details**:
- ‚úÖ OTLP HTTP exporter with configurable endpoint
- ‚úÖ Resource attributes: service.name, service.version, environment
- ‚úÖ Batch span processor (512 batch size, 5s timeout)
- ‚úÖ Shutdown function for graceful cleanup
- ‚úÖ Tests pass (100% coverage in telemetry package)
- ‚ùå NOT CALLED from main command execution path

#### UC-OBS-02 (Root Spans): ‚ùå NO-GO
**Evidence**: `cmd/sc3/main.go:25-47` - NO tracer calls
**Gap**: Root spans NOT created on command execution
**Severity**: CRITICAL
**Verifiable Now**: NO
**Details**:
- ‚ùå main.go does NOT call telemetry.Init()
- ‚ùå No run_id generated (UUID required)
- ‚ùå No trace_id emitted
- ‚ùå No root span created with command.name, args, working_dir, git.head
- ‚ùå No span status tracking (OK/ERROR)
- **Impact**: Cannot correlate any traces or logs without root run_id

### PHASE 2: COMMANDER EXECUTION + PIPELINE TRACING

#### UC-EXEC-01 (Sequence and dispatch missions): ‚úÖ GO
**Evidence**: `internal/commander/commander.go:233-258` (Execute), `internal/commander/waves.go`
**Gap**: None
**Verifiable Now**: YES
**Details**:
- ‚úÖ Manifest reading from Beads
- ‚úÖ Wave computation from dependency graph
- ‚úÖ WIP limit enforcement (configurable)
- ‚úÖ Batch execution with parallel dispatch

#### UC-EXEC-02 (Execute RED phase): ‚ö†Ô∏è PARTIAL
**Evidence**: `internal/commander/phases/red.go` exists
**Gap**: Per-AC TDD cycle execution exists but NOT integrated with telemetry
**Severity**: MEDIUM
**Verifiable Now**: YES (phase logic works, tracing missing)
**Details**:
- ‚úÖ RED phase dispatch logic exists
- ‚ùå No span emission for RED phase execution
- ‚ùå No correlation with run_id/trace_id

#### UC-EXEC-03 (Execute GREEN phase): ‚ö†Ô∏è PARTIAL
**Evidence**: `internal/commander/phases/green.go` exists
**Gap**: Same as RED - no telemetry integration
**Severity**: MEDIUM
**Verifiable Now**: YES

#### UC-EXEC-04 (Execute REFACTOR phase): ‚ö†Ô∏è PARTIAL
**Evidence**: `internal/commander/phases/refactor.go` exists
**Gap**: Same as RED/GREEN - no telemetry integration
**Severity**: MEDIUM
**Verifiable Now**: YES

#### UC-EXEC-05 (Route STANDARD_OPS fast path): ‚úÖ GO
**Evidence**: `internal/commander/commander.go:370-384` (isStandardOpsMission check)
**Gap**: None
**Verifiable Now**: YES
**Details**:
- ‚úÖ Classification check (MissionClassificationStandardOps)
- ‚úÖ Simplified IMPLEMENT ‚Üí VERIFY ‚Üí Demo Token flow
- ‚úÖ VerifyImplement gate for STANDARD_OPS

#### UC-EXEC-06 (Enforce mission termination): ‚úÖ GO
**Evidence**: `internal/commander/commander.go:427-446` (haltBeforeDispatch)
**Gap**: None
**Verifiable Now**: YES
**Details**:
- ‚úÖ maxRevisions enforcement (default 3)
- ‚úÖ ACAttemptsExhausted check
- ‚úÖ ManualHalt support
- ‚úÖ HaltReason enum (MaxRevisionsExceeded, ACExhausted, ManualHalt, etc.)

#### UC-EXEC-07 (Validate demo token): ‚úÖ GO
**Evidence**: `internal/demo/validator.go`
**Gap**: None
**Verifiable Now**: YES
**Details**:
- ‚úÖ Markdown YAML frontmatter validation
- ‚úÖ Required fields check (mission_id, title, classification, status)
- ‚úÖ diff_refs validation (referenced files exist)
- ‚úÖ Mode-dependent section requirements (RED_ALERT vs STANDARD_OPS)
- ‚úÖ Test coverage: 81.2%

#### UC-EXEC-08 (Dispatch domain reviewer): ‚ùå NO-GO
**Evidence**: Nowhere in commander code
**Gap**: Reviewer dispatch NOT implemented
**Severity**: HIGH
**Verifiable Now**: NO
**Details**:
- ‚ùå No reviewer dispatch after implementer completion
- ‚ùå No context isolation (different ensign for review)
- ‚ùå No diff + gate evidence + AC context passed to reviewer
- ‚ùå No APPROVED/NEEDS_FIXES verdict handling

#### UC-EXEC-09 (Handle review verdict): ‚ùå NO-GO
**Evidence**: Nowhere in commander code
**Gap**: Review verdict processing NOT implemented
**Severity**: HIGH
**Verifiable Now**: NO
**Details**:
- ‚ùå No APPROVED ‚Üí mission.done transition
- ‚ùå No NEEDS_FIXES ‚Üí revisionCount increment
- ‚ùå No maxRevisions halt after NEEDS_FIXES

#### UC-EXEC-10 (Report status to Captain): ‚ö†Ô∏è PARTIAL
**Evidence**: `internal/commander/commander.go:392-400` (publish completion), `internal/commander/commander.go:405-421` (publishHalt)
**Gap**: Events published but Captain tracking NOT implemented
**Severity**: MEDIUM
**Verifiable Now**: YES (events work, Captain monitoring missing)
**Details**:
- ‚úÖ EventMissionCompleted published
- ‚úÖ EventMissionHalted published with reason
- ‚ùå Captain-side status tracking not implemented (ready room is separate phase)

#### UC-EXEC-11 (Admiral wave review): ‚ùå NO-GO
**Evidence**: Nowhere in commander code
**Gap**: Wave review checkpoint NOT implemented
**Severity**: HIGH
**Verifiable Now**: NO
**Details**:
- ‚ùå No demo token presentation after wave completion
- ‚ùå No continue/feedback/halt decision point
- ‚ùå No feedback injection into next wave context

#### UC-GATE-01 (Execute VERIFY_RED gate): ‚úÖ GO
**Evidence**: `internal/gates/gate.go`, `internal/gates/executor.go`
**Gap**: None
**Verifiable Now**: YES
**Details**:
- ‚úÖ Shell command execution with timeout (default 120s)
- ‚úÖ Exit code parsing (0 = reject_vanity, syntax error = reject_syntax, test failure = accept)
- ‚úÖ Output capture (1MB limit)
- ‚úÖ Test coverage: 85.1% in gates package

#### UC-GATE-02 (Execute VERIFY_GREEN gate): ‚úÖ GO
**Evidence**: Same gate executor
**Gap**: None
**Verifiable Now**: YES

#### UC-GATE-03 (Execute VERIFY_REFACTOR gate): ‚úÖ GO
**Evidence**: Same gate executor
**Gap**: None
**Verifiable Now**: YES

#### UC-GATE-04 (Execute VERIFY_IMPLEMENT gate): ‚úÖ GO
**Evidence**: `internal/commander/commander.go:371-374` (VerifyImplement call)
**Gap**: None
**Verifiable Now**: YES
**Details**:
- ‚úÖ typecheck, lint, build commands supported
- ‚úÖ All must pass (sequential execution)

#### UC-GATE-05 (Record gate evidence): ‚úÖ GO
**Evidence**: `internal/gates/evidence.go`
**Gap**: None
**Verifiable Now**: YES
**Details**:
- ‚úÖ GateEvidence struct with exit code, classification, output snippet, timestamp
- ‚úÖ Persistence to Beads
- ‚úÖ Test coverage: evidence_test.go exists

#### UC-GATE-06 (Publish protocol event): ‚úÖ GO
**Evidence**: `internal/protocol/protocol.go`, `internal/protocol/store.go`
**Gap**: None
**Verifiable Now**: YES
**Details**:
- ‚úÖ ProtocolEvent struct with protocol_version: "1.0"
- ‚úÖ AGENT_CLAIM, GATE_RESULT, STATE_TRANSITION event types
- ‚úÖ JSON schema validation
- ‚úÖ Persistence to Beads
- ‚úÖ Test coverage: 78.2%

#### UC-GATE-07 (Wait for agent claim): ‚ö†Ô∏è PARTIAL
**Evidence**: Protocol store can query events, but polling logic NOT implemented
**Gap**: Commander does NOT poll for AGENT_CLAIM events
**Severity**: MEDIUM
**Verifiable Now**: NO (harness integration incomplete)
**Details**:
- ‚úÖ Protocol event storage exists
- ‚ùå No polling loop for expected claims
- ‚ùå No timeout escalation (5 minutes)

#### UC-GATE-08 (Configure gate commands per mission): ‚ö†Ô∏è PARTIAL
**Evidence**: Mission struct has no gate command fields
**Gap**: test_command, typecheck_command, lint_command, build_command NOT stored on Mission
**Severity**: MEDIUM
**Verifiable Now**: NO
**Details**:
- ‚ùå Mission struct missing gate configuration fields
- ‚ùå No variable substitution support ({test_file}, {worktree_dir}, {mission_id})
- ‚ùå No project-level defaults from config

#### UC-OBS-03 (Deterministic tracing): ‚ùå NO-GO
**Evidence**: No span emission in any execution code
**Gap**: NO spans for state transitions, tools, Git ops, tests
**Severity**: CRITICAL
**Verifiable Now**: NO
**Details**:
- ‚ùå No state transition spans (from_state, to_state, reason)
- ‚ùå No tool execution spans (tool_name, args_redacted, cwd, duration_ms, exit_code)
- ‚ùå No Git operation spans (checkout/worktree/apply_patch/diff)
- ‚ùå No test run spans (command, duration_ms, passed, failed_count)
- **Impact**: Cannot diagnose WHERE something broke without deterministic traces

#### UC-OBS-05, UC-OBS-06 (Structured logging): ‚ùå NO-GO
**Evidence**: `internal/logging/logger.go:32-46` - NO run_id/trace_id fields
**Gap**: Logs written to JSON file but NOT correlated with traces
**Severity**: CRITICAL
**Verifiable Now**: NO
**Details**:
- ‚úÖ JSON logs written to `~/.sc3/logs/sc3-{timestamp}.log`
- ‚úÖ Log rotation (filename timestamped, no size limit yet)
- ‚ùå NO run_id field in log records
- ‚ùå NO trace_id field in log records
- ‚ùå NO span_id correlation
- ‚ùå Log format: timestamp, level, message ONLY (missing structured fields)
- **Impact**: Cannot jump from log line to span or vice versa

#### UC-OBS-07 (Detect invariant violations): ‚ùå NO-GO
**Evidence**: No invariant checking code
**Gap**: NO telemetry events for invariant violations
**Severity**: MEDIUM
**Verifiable Now**: NO
**Details**:
- ‚ùå No invariant.violation events emitted
- ‚ùå No pre-defined invariants (patch_apply_clean, repo_clean_before_merge, etc.)
- ‚ùå No context tracking (what_invariant, where_detected, why_violated, stack_trace)

#### UC-OBS-08 (Support debug mode): ‚ùå NO-GO
**Evidence**: No --debug flag in CLI
**Gap**: NO console exporter or verbose logging
**Severity**: MEDIUM
**Verifiable Now**: NO
**Details**:
- ‚ùå No --debug flag in cobra commands
- ‚ùå No console span exporter
- ‚ùå No DEBUG level logging toggle
- ‚ùå No span events printed to console

#### UC-OBS-09 (Override OTel endpoint): ‚ö†Ô∏è PARTIAL
**Evidence**: `internal/telemetry/telemetry.go:82-88` (resolveEndpoint)
**Gap**: Env var supported but --otel-endpoint flag NOT implemented
**Severity**: LOW
**Verifiable Now**: PARTIAL (env var works, flag missing)
**Details**:
- ‚úÖ OTEL_EXPORTER_OTLP_ENDPOINT env var supported
- ‚úÖ Falls back to http://localhost:4318
- ‚ùå No --otel-endpoint CLI flag
- ‚ùå No fallback to console if endpoint unreachable (no warning)

#### UC-OBS-10 (Generate debug bundle): ‚ùå NO-GO
**Evidence**: No sc3 bugreport command
**Gap**: NO debug bundle generation
**Severity**: HIGH
**Verifiable Now**: NO
**Details**:
- ‚ùå No `sc3 bugreport` command
- ‚ùå No tarball generation (logs, config, version, Git state, test output)
- ‚ùå No secrets redaction logic
- ‚ùå No README.txt in bundle

---

## Gap Inventory

### Critical Gaps (Blocking Phase 1-2 Completion)

1. **NO ROOT SPANS** (UC-OBS-02) - CRITICAL
   - Impact: Cannot correlate traces or logs
   - File: `cmd/sc3/main.go:25-47` needs telemetry.Init() call
   - Fix: Call telemetry.Init() in run(), generate run_id (UUID), create root span

2. **NO DETERMINISTIC TRACING** (UC-OBS-03) - CRITICAL
   - Impact: Cannot diagnose WHERE something broke
   - Files: All execution paths need span emission
   - Fix: Wrap state transitions, tools, Git ops, tests in tracer.Start()

3. **NO LOG CORRELATION** (UC-OBS-06) - CRITICAL
   - Impact: Cannot link logs to traces
   - File: `internal/logging/logger.go:32-46`
   - Fix: Add run_id, trace_id, span_id fields to log records

4. **NO REVIEW DISPATCH** (UC-EXEC-08) - HIGH
   - Impact: No independent verification loop
   - File: Missing from commander
   - Fix: Add reviewer dispatch after implementer completion

5. **NO sc3 bugreport COMMAND** (UC-OBS-10) - HIGH
   - Impact: Cannot debug issues offline
   - File: Missing from cmd/sc3/main.go
   - Fix: Implement bugreport subcommand

### High Gaps (Should Fix Before Release)

6. **NO WAVE REVIEW CHECKPOINT** (UC-EXEC-11) - HIGH
   - Impact: No feedback loop between waves
   - File: Missing from commander
   - Fix: Add wave review after each wave completion

7. **NO HARNESS INTEGRATION** (UC-COMM-03/04/05) - HIGH
   - Impact: Ready Room cannot spawn real agent sessions
   - File: Missing harness drivers
   - Fix: Implement Claude Code/Codex drivers (UC-HARN-02/UC-HARN-03)

8. **NO GATE COMMAND CONFIG** (UC-GATE-08) - MEDIUM
   - Impact: Cannot customize test/lint commands per mission
   - File: Mission struct missing fields
   - Fix: Add test_command, typecheck_command, lint_command, build_command fields

9. **NO AGENT CLAIM POLLING** (UC-GATE-07) - MEDIUM
   - Impact: Commander cannot wait for agent responses
   - File: Missing from commander
   - Fix: Add polling loop with timeout escalation

### Medium Gaps (Fix Soon)

10. **NO --debug FLAG** (UC-OBS-08) - MEDIUM
    - Impact: Cannot enable console exporter for troubleshooting
    - File: cmd/sc3/main.go
    - Fix: Add --debug flag, console exporter, DEBUG logging

11. **NO INVARIANT CHECKING** (UC-OBS-07) - MEDIUM
    - Impact: Cannot detect system violations
    - File: Missing
    - Fix: Add invariant checks and telemetry events

---

## What You Can Verify Right Now

### ‚úÖ Testable (77.3% coverage)

1. **Run all tests**:
   ```bash
   go test ./...
   ```
   Expected: All pass, 77.3% coverage

2. **Test commission parsing**:
   ```bash
   ./sc3 plan .spec/prd.md
   ```
   Expected: Parses use cases, acceptance criteria, functional groups, scope

3. **Test state machine**:
   ```bash
   go test -v ./internal/state/...
   ```
   Expected: All state transitions validated

4. **Test demo token validation**:
   ```bash
   go test -v ./internal/demo/...
   ```
   Expected: YAML frontmatter validation, diff_refs checking

5. **Test gate executor**:
   ```bash
   go test -v ./internal/gates/...
   ```
   Expected: Shell command execution, exit code parsing, timeout enforcement

6. **Test protocol events**:
   ```bash
   go test -v ./internal/protocol/...
   ```
   Expected: JSON schema validation, persistence to Beads

### ‚ùå NOT Testable (Missing Implementation)

1. **End-to-end telemetry flow**:
   - ‚ùå No run_id generated in main command
   - ‚ùå No root spans created
   - ‚ùå No span emission in execution paths
   - ‚ùå No log correlation with traces

2. **Ready Room with real agents**:
   - ‚ùå No harness drivers (Claude Code, Codex)
   - ‚ùå Cannot spawn actual planning sessions

3. **Commander execution**:
   - ‚ùå No worktree creation (interface defined, implementation missing)
   - ‚ùå No surface-area locks (interface defined, implementation missing)
   - ‚ùå No harness dispatch (interface defined, implementation missing)

4. **Review loop**:
   - ‚ùå No reviewer dispatch
   - ‚ùå No wave review checkpoint

5. **Debug bundles**:
   - ‚ùå No sc3 bugreport command

---

## Coding Standards Violations

### Go Patterns
‚úÖ **PASS** - Code follows idiomatic Go patterns:
- Context propagation (ctx context.Context)
- Error wrapping (fmt.Errorf with %w)
- Interface-based design (SessionFactory, WorktreeManager, etc.)
- Test table patterns
- Proper package structure (internal/ layout)

### Test Coverage
‚ö†Ô∏è **WARN** - 77.3% overall, some gaps:
- `cmd/sc3`: 20.0% (main.go is scaffold, expected low)
- `internal/telemetry`: 100% (excellent)
- `internal/events`: 95.8% (excellent)
- Most packages: 70-85% (good)

### Documentation
‚ùå **FAIL** - Missing godoc comments on exported types:
- Mission struct fields need documentation
- Event struct fields need documentation
- Many exported functions lack examples

### Error Handling
‚úÖ **PASS** - Proper error wrapping throughout
‚úÖ **PASS** - Deterministic error types (HaltReason enum)

---

## New Acceptance Criteria

### AC-NEW-TECH-01: Root span creation in main command
- [ ] Import `internal/telemetry` package in cmd/sc3/main.go
- [ ] Call `telemetry.Init(ctx)` in `run()` function before config load
- [ ] Generate `run_id` (UUID v4) using `google.uuid` or `github.com/google/uuid`
- [ ] Create root span with `tracer.Start()` before command execution
- [ ] Set root span attributes: command.name, command.args (redacted), working_dir, git.head, git.branch, environment
- [ ] Set root span status: OK on success, ERROR on failure with error message
- [ ] Call shutdown func in defer after command execution
- [ ] Verify root span appears in OTel collector (Jaeger/Tempo)
- **Severity**: CRITICAL
- **Verifiable Now**: NO (requires implementation)

### AC-NEW-TECH-02: Structured logging with run_id/trace_id correlation
- [ ] Modify `internal/logging/logger.go` to accept `run_id` and `trace_id` parameters
- [ ] Add `run_id`, `trace_id`, `span_id` fields to log record schema
- [ ] Update `RuntimeLogger` to store run_id/trace_id context
- [ ] Add `WithRunID(runID string)` and `WithTraceID(traceID string)` helper methods
- [ ] Update log formatter to include run_id/trace_id in every log record
- [ ] Verify logs can be queried by run_id using grep/jq
- [ ] Verify trace_id can be used to jump from log to span in OTel backend
- **Severity**: CRITICAL
- **Verifiable Now**: NO

### AC-NEW-TECH-03: Deterministic tracing for state transitions
- [ ] Add `tracer` field to `internal/state/machine.go` Machine struct
- [ ] Wrap `Transition()` method in `tracer.Start()` span
- [ ] Set span attributes: from_state, to_state, reason, entity_type (commission/mission/ac)
- [ ] Emit span on every state transition
- [ ] Verify spans appear in trace with correct parent (root span or operation span)
- **Severity**: CRITICAL
- **Verifiable Now**: NO

### AC-NEW-TECH-04: Deterministic tracing for tool execution
- [ ] Create `internal/tracing/tools.go` with `ExecuteTool()` helper
- [ ] Wrap all shell command executions in tool execution spans
- [ ] Set span attributes: tool_name, args_redacted (secrets masked), cwd, duration_ms, exit_code
- [ ] Capture bounded stdout/stderr (first 1KB) as span events
- [ ] Apply to: gate execution, Git operations, test runs
- **Severity**: CRITICAL
- **Verifiable Now**: NO

### AC-NEW-TECH-05: Implement sc3 bugreport command
- [ ] Add `bugreport` subcommand to cmd/sc3/main.go
- [ ] Collect: last 3 log files from ~/.sc3/logs/
- [ ] Collect: redacted config from ~/.sc3/config.yaml (mask API keys, tokens, passwords)
- [ ] Collect: version info (`sc3 --version` output)
- [ ] Collect: last run_id/trace_id from state
- [ ] Collect: Git state (HEAD, diff, uncommitted changes)
- [ ] Collect: failing test output if last run failed
- [ ] Create tarball: `.sc3-bugreport-{timestamp}.tar.gz`
- [ ] Add README.txt with collection summary
- [ ] Exit with path to bugreport and instructions
- **Severity**: HIGH
- **Verifiable Now**: NO

### AC-NEW-TECH-06: Implement --debug flag for console exporter
- [ ] Add `--debug` flag to root cobra command
- [ ] If --debug set, call `telemetry.InitWithConsoleExporter()` instead of default
- [ ] Console exporter: Print spans to stderr in human-readable format
- [ ] Format: `[SPAN] span_name {duration} {status}` with indented children
- [ ] Set logging level to DEBUG in --debug mode
- [ ] Emit span events to console for verbose diagnostics
- **Severity**: MEDIUM
- **Verifiable Now**: NO

### AC-NEW-TECH-07: Implement reviewer dispatch in Commander
- [ ] Add `DispatchReviewer()` method to Harness interface
- [ ] After implementer completion, call `harness.DispatchReviewer()` with diff + gate evidence + AC
- [ ] Reviewer must be different ensign than implementer (context isolation)
- [ ] Wait for `REVIEW_COMPLETE` protocol event
- [ ] Process APPROVED verdict: transition mission to done
- [ ] Process NEEDS_FIXES verdict: increment revisionCount, re-dispatch implementer with feedback
- [ ] Check `revisionCount >= maxRevisions` after NEEDS_FIXES ‚Üí HALTED
- **Severity**: HIGH
- **Verifiable Now**: NO

### AC-NEW-TECH-08: Implement wave review checkpoint
- [ ] After all missions in wave complete, trigger wave review
- [ ] Collect demo tokens from all completed missions in wave
- [ ] Present demo tokens via ApprovalGate interface
- [ ] Support decisions: continue (next wave), feedback (inject into next wave context), halt (cancel commission)
- [ ] Inject feedback into next wave's mission dispatches if provided
- [ ] Persist wave feedback to Beads
- **Severity**: HIGH
- **Verifiable Now**: NO

### AC-NEW-TECH-09: Add gate command configuration to Mission struct
- [ ] Add fields to Mission struct: TestCommand, TypecheckCommand, LintCommand, BuildCommand (all string)
- [ ] Support variable substitution: {test_file}, {worktree_dir}, {mission_id}
- [ ] Load project-level defaults from config file if mission-specific commands not set
- [ ] Apply configured commands in gate execution
- [ ] Add tests for variable substitution logic
- **Severity**: MEDIUM
- **Verifiable Now**: NO

### AC-NEW-TECH-10: Implement agent claim polling in Commander
- [ ] Add `pollForClaim()` method to Commander
- [ ] Poll Beads protocol event store for expected claim type (e.g., RED_COMPLETE)
- [ ] Configurable timeout (default 5 minutes)
- [ ] Timeout ‚Üí escalation event (mission marked stuck, TUI notification)
- [ ] Return claim immediately when found
- **Severity**: MEDIUM
- **Verifiable Now**: NO

---

## Beads Status

### Review Scope
**Phase Beads**: `ship-commander-3-9sd` (Phase 1), `ship-commander-3-s6s` (Phase 2)
**Child Beads**: 50+ beads under phase epics

### Bead Mapping Summary

| Requirement | Bead ID | Status | Assessment |
|-------------|---------|--------|------------|
| UC-COMM-01 | ship-commander-3-9sd.2 | ‚úÖ COMPLETE | Commission parser works |
| UC-COMM-02 | ship-commander-3-9sd.4 | ‚úÖ COMPLETE | Ready Room interface defined |
| UC-COMM-03 | ship-commander-3-9sd.4 | ‚ö†Ô∏è PARTIAL | Session interface exists, harness missing |
| UC-COMM-04 | ship-commander-3-9sd.4 | ‚ö†Ô∏è PARTIAL | Same as UC-COMM-03 |
| UC-COMM-05 | ship-commander-3-9sd.4 | ‚ö†Ô∏è PARTIAL | Same as UC-COMM-03 |
| UC-COMM-06 | ship-commander-3-9sd.4 | ‚úÖ COMPLETE | Message routing works |
| UC-COMM-07 | ship-commander-3-9sd.4 | ‚úÖ COMPLETE | Consensus validation works |
| UC-COMM-08 | ship-commander-3-9sd.6 | ‚úÖ COMPLETE | Question gate implemented |
| UC-COMM-09 | ship-commander-3-9sd.5 | ‚úÖ COMPLETE | Approval gate implemented |
| UC-COMM-10 | ship-commander-3-9sd.5 | ‚úÖ COMPLETE | Plan persistence works |
| UC-OBS-01 | ship-commander-3-9sd.7 | ‚úÖ COMPLETE | Telemetry Init works |
| UC-OBS-02 | ship-commander-3-9sd.8 | ‚ùå INCOMPLETE | Root spans NOT created |
| UC-EXEC-01 through UC-EXEC-07 | ship-commander-3-s6s.* | ‚úÖ COMPLETE | Core commander works |
| UC-EXEC-08 | ship-commander-3-s6s.* | ‚ùå MISSING | No reviewer dispatch |
| UC-EXEC-09 | ship-commander-3-s6s.* | ‚ùå MISSING | No review verdict handling |
| UC-EXEC-10 | ship-commander-3-s6s.* | ‚ö†Ô∏è PARTIAL | Events published, Captain tracking missing |
| UC-EXEC-11 | ship-commander-3-s6s.* | ‚ùå MISSING | No wave review checkpoint |
| UC-GATE-01 through UC-GATE-06 | ship-commander-3-s6s.* | ‚úÖ COMPLETE | Gate engine works |
| UC-GATE-07 | ship-commander-3-s6s.* | ‚ö†Ô∏è PARTIAL | Protocol store exists, polling missing |
| UC-GATE-08 | ship-commander-3-s6s.* | ‚ùå INCOMPLETE | No gate config on Mission |
| UC-OBS-03 | ship-commander-3-s6s.6 | ‚ùå INCOMPLETE | No deterministic tracing |
| UC-OBS-05, UC-OBS-06 | ship-commander-3-s6s.7 | ‚ùå INCOMPLETE | No log correlation |
| UC-OBS-07 | ship-commander-3-ax2.4 | ‚ùå MISSING | No invariant checks |
| UC-OBS-08 | ship-commander-3-ax2.8 | ‚ùå MISSING | No --debug flag |
| UC-OBS-09 | ship-commander-3-ax2.6 | ‚ö†Ô∏è PARTIAL | Env var works, flag missing |
| UC-OBS-10 | ship-commander-3-ax2.5 | ‚ùå MISSING | No sc3 bugreport command |

### Execution Plan (Dependency-Ordered)

**Ready to Implement NOW** (unblocked):
1. **AC-NEW-TECH-01**: Root span creation in main command
   - Priority: CRITICAL
   - Blocks: All other observability work
   - Files: cmd/sc3/main.go, internal/telemetry/telemetry.go

2. **AC-NEW-TECH-02**: Structured logging with run_id/trace_id correlation
   - Priority: CRITICAL
   - Depends on: AC-NEW-TECH-01 (needs run_id generation)
   - Files: internal/logging/logger.go

3. **AC-NEW-TECH-03**: Deterministic tracing for state transitions
   - Priority: CRITICAL
   - Depends on: AC-NEW-TECH-01 (needs tracer initialized)
   - Files: internal/state/machine.go

4. **AC-NEW-TECH-04**: Deterministic tracing for tool execution
   - Priority: CRITICAL
   - Depends on: AC-NEW-TECH-01
   - Files: internal/tracing/tools.go (new), internal/gates/executor.go

**Ready After Tracing Infrastructure**:
5. **AC-NEW-TECH-05**: Implement sc3 bugreport command
   - Priority: HIGH
   - Depends on: AC-NEW-TECH-01, AC-NEW-TECH-02 (needs run_id, logs)
   - Files: cmd/sc3/main.go

6. **AC-NEW-TECH-06**: Implement --debug flag
   - Priority: MEDIUM
   - Depends on: AC-NEW-TECH-01
   - Files: cmd/sc3/main.go, internal/telemetry/telemetry.go

**Independent Work (Can Start Now)**:
7. **AC-NEW-TECH-07**: Implement reviewer dispatch
   - Priority: HIGH
   - Depends on: None (interface exists)
   - Files: internal/commander/commander.go, internal/harness/*

8. **AC-NEW-TECH-08**: Implement wave review checkpoint
   - Priority: HIGH
   - Depends on: None
   - Files: internal/commander/commander.go

9. **AC-NEW-TECH-09**: Add gate command configuration
   - Priority: MEDIUM
   - Depends on: None
   - Files: internal/commander/commander.go (Mission struct)

10. **AC-NEW-TECH-10**: Implement agent claim polling
    - Priority: MEDIUM
    - Depends on: None
    - Files: internal/commander/commander.go

---

## Re-Evaluation Criteria

When engineers report fixes complete, verify:

- [ ] AC-NEW-TECH-01: Run `sc3 plan .spec/prd.md` and check OTel collector for root span with run_id
- [ ] AC-NEW-TECH-02: Check ~/.sc3/logs/sc3-*.log for run_id/trace_id fields in JSON
- [ ] AC-NEW-TECH-03: Trigger state transition, verify span in trace with from_state/to_state attributes
- [ ] AC-NEW-TECH-04: Execute gate command, verify span with tool_name, exit_code, duration_ms
- [ ] AC-NEW-TECH-05: Run `sc3 bugreport`, verify tarball created with README.txt
- [ ] AC-NEW-TECH-06: Run `sc3 --debug plan .spec/prd.md`, verify spans printed to stderr
- [ ] AC-NEW-TECH-07: Run mission to completion, verify reviewer dispatched after implementer
- [ ] AC-NEW-TECH-08: Complete wave, verify wave review checkpoint triggered
- [ ] AC-NEW-TECH-09: Create mission with TestCommand set, verify gate uses configured command
- [ ] AC-NEW-TECH-10: Dispatch mission, verify polling for RED_COMPLETE claim

**Overall Completion Threshold**: ‚â•80% of requirements met
- Current: ~65%
- Target: ‚â•80%
- Critical gaps blocking completion: 4 (root spans, deterministic tracing, log correlation, reviewer dispatch)

---

## Team Assessments

### Product Manager (Team Lead)
**Role**: Orchestrated adversarial PRD code review
**Assessment**: Review complete. Identified 4 critical gaps, 4 high gaps, 2 medium gaps blocking phase completion. Strong foundation but observability integration is the blocker.

### Engineering Manager
**Role**: Technical requirements validation
**Assessment**: Code architecture is solid (interface-based design, proper error handling). Main gap is observability integration‚Äîtelemetry package exists but not wired into execution paths. Cannot trace operations or correlate logs without run_id/trace_id flow.

### Designer (Skipped)
**Role**: Design fidelity validation
**Assessment**: Not applicable for Phase 1-2. TUI components are Phase 3 (ship-commander-3-sta epic). No design validation required for backend/observability work.

---

## Next Steps

1. **IMMEDIATE** (Week 1):
   - Implement AC-NEW-TECH-01 (root spans) - CRITICAL, blocks all observability
   - Implement AC-NEW-TECH-02 (log correlation) - CRITICAL
   - Implement AC-NEW-TECH-03 (state transition tracing) - CRITICAL
   - Implement AC-NEW-TECH-04 (tool execution tracing) - CRITICAL

2. **SHORT-TERM** (Week 2):
   - Implement AC-NEW-TECH-05 (sc3 bugreport) - HIGH
   - Implement AC-NEW-TECH-07 (reviewer dispatch) - HIGH
   - Implement AC-NEW-TECH-08 (wave review checkpoint) - HIGH

3. **MEDIUM-TERM** (Week 3):
   - Implement AC-NEW-TECH-06 (--debug flag) - MEDIUM
   - Implement AC-NEW-TECH-09 (gate command config) - MEDIUM
   - Implement AC-NEW-TECH-10 (agent claim polling) - MEDIUM

4. **RE-EVALUATION**: After all critical fixes complete, re-run `/prd-code-review .spec/prd.md` to verify ‚â•80% completion.

---

**Report Generated**: 2026-02-10 23:48:41 UTC
**Review Tool**: /prd-code-review (adversarial PRD code review skill)
**Team**: prd-review-phases-1-2
